# ──────────────────────────────────────────────────────────────────────
# SCPN Fusion Core — Documentation Build & GitHub Pages Deploy
# (c) 1998-2026 Miroslav Sotek. All rights reserved.
# Contact: www.anulum.li | protoscience@anulum.li
# License: GNU AGPL v3 | Commercial licensing available
# ──────────────────────────────────────────────────────────────────────
name: Documentation

on:
  push:
    branches: [main]
    paths:
      - "docs/**"
      - "papers/**"
      - "**.rst"
      - "src/scpn_fusion/**"
      - ".github/workflows/docs.yml"
      - ".readthedocs.yaml"
      - "pyproject.toml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-${{ github.sha }}
  cancel-in-progress: false

jobs:
  build-python-docs:
    name: Build Python API docs (Sphinx)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install package
        run: pip install -e .

      - name: Install Sphinx dependencies
        run: pip install -r docs/sphinx/requirements.txt

      - name: Build Sphinx docs
        run: sphinx-build -b html docs/sphinx docs/sphinx/_build/html

      - name: Upload Python docs
        uses: actions/upload-artifact@v4
        with:
          name: python-docs
          path: docs/sphinx/_build/html/
          if-no-files-found: error

  build-rust-docs:
    name: Build Rust API docs (rustdoc)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-docs-

      - name: Build rustdoc
        working-directory: scpn-fusion-rs
        run: cargo doc --no-deps --all-features

      - name: Upload Rust docs
        uses: actions/upload-artifact@v4
        with:
          name: rust-docs
          path: scpn-fusion-rs/target/doc/
          if-no-files-found: error

  build-notebook-html:
    name: Build tutorial notebook HTML exports
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install jupyter nbconvert "jax<0.5.0" "jaxlib<0.5.0"

      - name: Convert notebooks to HTML
        run: |
          mkdir -p docs/notebooks
          python -m jupyter nbconvert --to html examples/*.ipynb --output-dir docs/notebooks/

      - name: Upload notebook HTML
        uses: actions/upload-artifact@v4
        with:
          name: notebook-html
          path: docs/notebooks/
          if-no-files-found: error

  deploy:
    name: Deploy to GitHub Pages
    needs: [build-python-docs, build-rust-docs, build-notebook-html]
    runs-on: ubuntu-latest
    env:
      PAGES_ARTIFACT_NAME: github-pages-${{ github.run_id }}-${{ github.run_attempt }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docs/assets/repo_header.png

      - name: Download Python docs
        uses: actions/download-artifact@v4
        with:
          name: python-docs
          path: site/python/

      - name: Download Rust docs
        uses: actions/download-artifact@v4
        with:
          name: rust-docs
          path: site/rust/

      - name: Download notebook HTML
        uses: actions/download-artifact@v4
        with:
          name: notebook-html
          path: site/notebooks/

      - name: Create notebook index page
        run: |
          cat > site/notebooks/index.html << 'NBEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>Tutorial Notebooks — SCPN Fusion Core</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { font-family: 'SF Mono', 'Fira Code', monospace; background: #00050a; color: #c8d6e5; min-height: 100vh; }
              .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
              h1 { color: #fff; font-size: 1.6em; margin-bottom: 8px; }
              .subtitle { color: #00ccff; font-size: 0.9em; margin-bottom: 24px; }
              .back { color: #60a5fa; text-decoration: none; font-size: 0.85em; display: inline-block; margin-bottom: 24px; }
              .back:hover { text-decoration: underline; }
              .nb { display: block; background: #0a1628; border: 1px solid #1a2a44; border-radius: 8px; padding: 16px 20px; margin-bottom: 12px; text-decoration: none; transition: border-color 0.2s; }
              .nb:hover { border-color: #00ccff; }
              .nb h2 { color: #fff; font-size: 1em; margin-bottom: 4px; }
              .nb p { color: #6688aa; font-size: 0.8em; }
              .badge { display: inline-block; font-size: 0.65em; padding: 2px 8px; border-radius: 4px; background: #1a3a2a; color: #66cc88; margin-right: 6px; }
            </style>
          </head>
          <body>
            <div class="container">
              <a class="back" href="../">&larr; Back to documentation</a>
              <h1>Tutorial Notebooks</h1>
              <div class="subtitle">Interactive Jupyter tutorials with Colab &amp; Binder badges</div>
              <a class="nb" href="01_compact_reactor_search.html">
                <span class="badge">01</span>
                <h2>Compact Reactor Search</h2>
                <p>Design-point scanning for compact tokamak configurations with global optimiser.</p>
              </a>
              <a class="nb" href="02_neuro_symbolic_compiler.html">
                <span class="badge">02</span>
                <h2>Neuro-Symbolic Compiler</h2>
                <p>Petri net &rarr; SNN compilation pipeline with formal verification.</p>
              </a>
              <a class="nb" href="03_grad_shafranov_equilibrium.html">
                <span class="badge">03</span>
                <h2>Grad-Shafranov Equilibrium</h2>
                <p>Picard iteration + SOR/multigrid solver validated against SPARC GEQDSK.</p>
              </a>
              <a class="nb" href="04_divertor_and_neutronics.html">
                <span class="badge">04</span>
                <h2>Divertor &amp; Neutronics</h2>
                <p>Eich heat-flux model, blanket neutronics, tritium breeding ratio.</p>
              </a>
              <a class="nb" href="05_validation_against_experiments.html">
                <span class="badge">05</span>
                <h2>Validation Against Experiments</h2>
                <p>SPARC, ITER 15 MA, ITPA H-mode database benchmarks.</p>
              </a>
              <a class="nb" href="06_inverse_and_transport_benchmarks.html">
                <span class="badge">06</span>
                <h2>Inverse &amp; Transport Benchmarks</h2>
                <p>Inverse equilibrium reconstruction and 1.5D transport solver convergence.</p>
              </a>
              <a class="nb" href="07_multi_ion_transport.html">
                <span class="badge">07</span>
                <h2>Multi-Ion Transport</h2>
                <p>D/T fuel, He-ash, independent Te, coronal radiation, Bremsstrahlung.</p>
              </a>
              <a class="nb" href="08_mhd_stability.html">
                <span class="badge">08</span>
                <h2>MHD Stability</h2>
                <p>Mercier, ballooning, Kruskal-Shafranov, Troyon, and NTM criteria.</p>
              </a>
              <a class="nb" href="09_coil_optimization.html">
                <span class="badge">09</span>
                <h2>Coil Optimization</h2>
                <p>Free-boundary GS with Tikhonov-regularised coil current optimisation.</p>
              </a>
              <a class="nb" href="10_uncertainty_quantification.html">
                <span class="badge">10</span>
                <h2>Uncertainty Quantification</h2>
                <p>Full-chain Monte Carlo UQ through equilibrium &rarr; transport &rarr; fusion power.</p>
              </a>
              <a class="nb" href="platinum_standard_demo_v1.html" style="border-color: #ff00ff;">
                <span class="badge" style="background: #3a1a3a; color: #ff66ff;">MASTER</span>
                <h2>Platinum Standard Demo</h2>
                <p><b>Project TOKAMAK-MASTER:</b> JAX-accelerated NMPC, Rutherford resistive MHD, and quantitative SOC calibration.</p>
              </a>
            </div>
          </body>
          </html>
          NBEOF

      - name: Copy header image
        run: |
          mkdir -p site/assets
          cp docs/assets/repo_header.png site/assets/ 2>/dev/null || true

      - name: Create .nojekyll
        run: touch site/.nojekyll

      - name: Create landing page
        run: |
          cat > site/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>SCPN Fusion Core — Documentation</title>
            <style>
              :root {
                --bg: #00050a;
                --card: #0a1628;
                --border: #1a2a44;
                --text: #c8d6e5;
                --heading: #ffffff;
                --accent: #00ccff;
                --accent2: #ff00ff;
                --link: #60a5fa;
              }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
                background: var(--bg);
                color: var(--text);
                min-height: 100vh;
              }
              .hero {
                text-align: center;
                padding: 40px 20px 20px;
              }
              .hero img {
                max-width: 960px;
                width: 100%;
                border-radius: 8px;
                border: 1px solid var(--border);
              }
              .hero h1 {
                color: var(--heading);
                font-size: 2em;
                margin: 24px 0 8px;
                letter-spacing: 0.05em;
              }
              .hero .subtitle {
                color: var(--accent);
                font-size: 1em;
                margin-bottom: 8px;
              }
              .hero .tagline {
                color: #6688aa;
                font-size: 0.85em;
                max-width: 700px;
                margin: 0 auto 32px;
                line-height: 1.5;
              }
              .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
                max-width: 960px;
                margin: 0 auto;
                padding: 0 20px 60px;
              }
              .card {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 24px;
                transition: border-color 0.2s;
                text-decoration: none;
                display: block;
              }
              .card:hover {
                border-color: var(--accent);
              }
              .card h2 {
                color: var(--heading);
                font-size: 1.1em;
                margin-bottom: 8px;
              }
              .card .lang {
                display: inline-block;
                font-size: 0.7em;
                padding: 2px 8px;
                border-radius: 4px;
                margin-bottom: 10px;
              }
              .card .lang.python { background: #1a3a5c; color: #60a5fa; }
              .card .lang.rust { background: #3a1a1a; color: #ff8866; }
              .card .lang.jupyter { background: #1a3a2a; color: #66cc88; }
              .card .lang.github { background: #2a2a3a; color: #c8c8ff; }
              .card p {
                color: #8899aa;
                font-size: 0.85em;
                line-height: 1.5;
              }
              .footer {
                text-align: center;
                padding: 20px;
                color: #445566;
                font-size: 0.75em;
                border-top: 1px solid var(--border);
              }
              .footer a { color: #6688aa; text-decoration: none; }
              .footer a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <div class="hero">
              <img src="assets/repo_header.png"
                   alt="SCPN Fusion Core — Neuro-Symbolic Tokamak Control"
                   onerror="this.style.display='none'">
              <h1>SCPN Fusion Core</h1>
              <div class="subtitle">Neuro-Symbolic Tokamak Control Framework</div>
              <div class="tagline">
                Dual-language (Python + Rust) open-source framework for tokamak plasma control.
                Petri net &rarr; SNN compilation, Grad-Shafranov equilibrium, AI surrogates,
                and real-time digital twins &mdash; validated against 8 SPARC GEQDSK equilibria.
              </div>
            </div>
            <div class="grid">
              <a class="card" href="python/">
                <span class="lang python">Python</span>
                <h2>Python API Reference</h2>
                <p>Sphinx-generated documentation for all 46 Python modules: equilibrium, transport, control, nuclear, diagnostics, SCPN compiler.</p>
              </a>
              <a class="card" href="rust/fusion_core/">
                <span class="lang rust">Rust</span>
                <h2>Rust API Reference</h2>
                <p>Rustdoc for the 10-crate workspace: fusion-core, fusion-math, fusion-control, fusion-physics, fusion-ml, and more.</p>
              </a>
              <a class="card" href="notebooks/">
                <span class="lang jupyter">Jupyter</span>
                <h2>Tutorial Notebooks</h2>
                <p>10 interactive tutorials: reactor search, neuro-symbolic compiler, GS equilibrium, neutronics, validation, benchmarks, multi-ion transport, MHD stability, coil optimisation, UQ.</p>
              </a>
              <a class="card" href="https://github.com/anulum/scpn-fusion-core">
                <span class="lang github">GitHub</span>
                <h2>Source Repository</h2>
                <p>Clone, fork, or contribute. AGPL-3.0 licensed. 205+ Rust tests, 60+ Python tests. CI/CD with GitHub Actions.</p>
              </a>
            </div>
            <div class="footer">
              &copy; 1998&ndash;2026 Miroslav &Scaron;otek &middot;
              <a href="https://www.anulum.li">anulum.li</a> &middot;
              AGPL-3.0
            </div>
          </body>
          </html>
          HTMLEOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          name: ${{ env.PAGES_ARTIFACT_NAME }}
          path: site/

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: ${{ env.PAGES_ARTIFACT_NAME }}
