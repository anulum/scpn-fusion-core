# ──────────────────────────────────────────────────────────────────────
# SCPN Fusion Core — Continuous Integration
# © 1998–2026 Miroslav Šotek. All rights reserved.
# Contact: www.anulum.li | protoscience@anulum.li
# License: GNU AGPL v3 | Commercial licensing available
# ──────────────────────────────────────────────────────────────────────
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  python-tests:
    name: Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run tests
        run: pytest tests/ -v
      - name: Run property-based tests (Hypothesis)
        run: pytest tests/test_hypothesis_properties.py -v --hypothesis-seed=0

  rust-tests:
    name: Rust (stable)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      - name: Check formatting
        run: cargo fmt --all -- --check
      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
      - name: Run tests
        run: cargo test --all-features

  rust-coverage:
    name: Rust Coverage (tarpaulin)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-tarpaulin-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-tarpaulin-
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin
      - name: Generate coverage
        run: cargo tarpaulin --packages fusion-types fusion-math fusion-core fusion-physics fusion-nuclear fusion-engineering fusion-control fusion-diagnostics fusion-ml --timeout 300 --out xml --output-dir coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: scpn-fusion-rs/coverage/cobertura.xml
          flags: rust
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  rust-audit:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run security audit
        run: cargo audit

  rust-benchmarks:
    name: Rust Benchmarks (dry run)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-bench-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-bench-
      - name: Compile benchmarks (verify they build)
        run: cargo bench --no-run
