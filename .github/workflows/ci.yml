# ──────────────────────────────────────────────────────────────────────
# SCPN Fusion Core — Continuous Integration
# © 1998–2026 Miroslav Šotek. All rights reserved.
# Contact: www.anulum.li | protoscience@anulum.li
# License: GNU AGPL v3 | Commercial licensing available
# ──────────────────────────────────────────────────────────────────────
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  python-tests:
    name: Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Bootstrap optional sc-neurocore modules (Python 3.12 lane)
        if: matrix.python-version == '3.12'
        run: |
          python - <<'PY'
          import importlib.util
          import shutil
          import subprocess
          import sys

          if importlib.util.find_spec("sc_neurocore") is not None:
              print("sc_neurocore already available.")
              raise SystemExit(0)

          if shutil.which("rustc") is None:
              print("rustc not available in this lane; continuing with numpy fallback path.")
              raise SystemExit(0)

          cmd = [
              sys.executable,
              "-m",
              "pip",
              "install",
              "git+https://github.com/anulum/sc-neurocore.git@df81aa28fd2db55665cacd87c3c4a62b7d8e077f#subdirectory=bridge",
          ]
          result = subprocess.run(cmd, check=False)
          if result.returncode != 0:
              print("Optional sc-neurocore bootstrap failed; continuing with fallback path.")
          PY
      - name: Run tests
        run: pytest tests/ -v
      - name: Run property-based tests (Hypothesis)
        run: pytest tests/test_hypothesis_properties.py -v --hypothesis-seed=0
      - name: Static typing (SCPN strict)
        if: matrix.python-version == '3.12'
        env:
          PYTHONPATH: src
        run: |
          python -m mypy --strict \
            src/scpn_fusion/scpn/contracts.py \
            src/scpn_fusion/scpn/controller.py \
            src/scpn_fusion/scpn/structure.py \
            src/scpn_fusion/scpn/artifact.py \
            src/scpn_fusion/scpn/compiler.py \
            src/scpn_fusion/scpn/__init__.py

  geometry-3d-smoke:
    name: Geometry 3D Smoke
    runs-on: ubuntu-latest
    needs: [python-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run 3D quickstart smoke
        run: |
          python examples/run_3d_flux_quickstart.py --toroidal 12 --poloidal 12 --output artifacts/ci_3d_smoke.obj
          python examples/run_3d_flux_quickstart.py --vmec-like --n1-amplitude 0.04 --toroidal 12 --poloidal 12 --output artifacts/ci_3d_vmec_smoke.obj
      - name: Validate OBJ artifact
        run: |
          python - <<'PY'
          from pathlib import Path
          def validate_obj(path: Path) -> None:
              if not path.exists() or path.stat().st_size == 0:
                  raise SystemExit(f"OBJ artifact missing or empty: {path}")
              verts = 0
              faces = 0
              for line in path.read_text(encoding="utf-8").splitlines():
                  if line.startswith("v "):
                      verts += 1
                  elif line.startswith("f "):
                      faces += 1
              if verts <= 0 or faces <= 0:
                  raise SystemExit(f"Invalid mesh content for {path}: verts={verts}, faces={faces}")
              print(f"OBJ smoke OK {path.name}: verts={verts}, faces={faces}")

          validate_obj(Path("artifacts/ci_3d_smoke.obj"))
          validate_obj(Path("artifacts/ci_3d_vmec_smoke.obj"))
          PY

  rmse-dashboard-smoke:
    name: RMSE Dashboard Smoke
    runs-on: ubuntu-latest
    needs: [python-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Generate RMSE dashboard
        run: |
          python validation/rmse_dashboard.py --output-json artifacts/rmse_dashboard_ci.json --output-md artifacts/rmse_dashboard_ci.md
      - name: Validate dashboard artifacts
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          j = Path("artifacts/rmse_dashboard_ci.json")
          m = Path("artifacts/rmse_dashboard_ci.md")
          if not j.exists() or j.stat().st_size == 0:
              raise SystemExit("Missing RMSE JSON artifact")
          if not m.exists() or m.stat().st_size == 0:
              raise SystemExit("Missing RMSE Markdown artifact")
          data = json.loads(j.read_text(encoding="utf-8"))
          for key in ("confinement_itpa", "confinement_iter_sparc", "beta_iter_sparc", "sparc_axis"):
              if key not in data:
                  raise SystemExit(f"Missing key: {key}")
          print("RMSE dashboard smoke OK")
          PY
      - name: Upload RMSE artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rmse-dashboard-smoke
          path: |
            artifacts/rmse_dashboard_ci.json
            artifacts/rmse_dashboard_ci.md

  rust-tests:
    name: Rust (stable)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      - name: Check formatting
        run: cargo fmt --all -- --check
      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
      - name: Run tests
        run: cargo test --all-features

  rust-coverage:
    name: Rust Coverage (tarpaulin)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-tarpaulin-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-tarpaulin-
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin
      - name: Generate coverage
        run: cargo tarpaulin --packages fusion-types fusion-math fusion-physics fusion-nuclear fusion-engineering fusion-control fusion-diagnostics fusion-ml --run-types Lib --timeout 300 --out xml --output-dir coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: scpn-fusion-rs/coverage/cobertura.xml
          flags: rust
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  rust-audit:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run security audit
        run: cargo audit

  rust-benchmarks:
    name: Rust Benchmarks (dry run)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-bench-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-bench-
      - name: Compile benchmarks (verify they build)
        run: cargo bench --no-run

  validation-regression:
    name: Physics Validation Suite
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Bootstrap optional sc-neurocore modules
        run: |
          python - <<'PY'
          import importlib.util
          import shutil
          import subprocess
          import sys

          if importlib.util.find_spec("sc_neurocore") is not None:
              print("sc_neurocore already available.")
              raise SystemExit(0)

          if shutil.which("rustc") is None:
              print("rustc not available in this lane; continuing with numpy fallback path.")
              raise SystemExit(0)

          cmd = [
              sys.executable,
              "-m",
              "pip",
              "install",
              "git+https://github.com/anulum/sc-neurocore.git@df81aa28fd2db55665cacd87c3c4a62b7d8e077f#subdirectory=bridge",
          ]
          result = subprocess.run(cmd, check=False)
          if result.returncode != 0:
              print("Optional sc-neurocore bootstrap failed; continuing with fallback path.")
          PY
      - name: IPB98 confinement scaling validation
        run: pytest tests/test_uncertainty.py -v --tb=short
      - name: Full regression suite
        run: pytest tests/ -v --tb=short -x
