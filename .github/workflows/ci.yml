# ──────────────────────────────────────────────────────────────────────
# SCPN Fusion Core — Continuous Integration
# © 1998–2026 Miroslav Šotek. All rights reserved.
# Contact: www.anulum.li | protoscience@anulum.li
# License: GNU AGPL v3 | Commercial licensing available
# ──────────────────────────────────────────────────────────────────────
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}-${{ github.sha }}
  cancel-in-progress: false

jobs:
  ci-chain-guard:
    name: CI Chain Guard
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Detect stale/duplicate in-progress CI chains
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SHA: ${{ github.sha }}
          MAX_STALE_MINUTES: "180"
        run: |
          python - <<'PY'
          from __future__ import annotations

          import json
          import os
          import sys
          import urllib.request
          from datetime import datetime, timezone

          repo = os.environ["GITHUB_REPOSITORY"]
          workflow = os.environ["GITHUB_WORKFLOW"]
          ref_name = os.environ.get("GITHUB_REF_NAME", "")
          run_id = int(os.environ["GITHUB_RUN_ID"])
          sha = os.environ.get("GITHUB_SHA", "")
          max_stale_minutes = float(os.environ.get("MAX_STALE_MINUTES", "180"))
          token = os.environ.get("GITHUB_TOKEN", "")
          if not token:
              raise SystemExit("Missing GITHUB_TOKEN for CI chain guard.")

          req = urllib.request.Request(
              f"https://api.github.com/repos/{repo}/actions/runs?status=in_progress&per_page=100",
              headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
                  "X-GitHub-Api-Version": "2022-11-28",
              },
          )
          with urllib.request.urlopen(req, timeout=30) as resp:
              payload = json.load(resp)
          runs = payload.get("workflow_runs", [])
          now = datetime.now(timezone.utc)

          duplicates: list[tuple[int, str, float | None]] = []
          stale: list[tuple[int, str, float | None]] = []
          for run in runs:
              if int(run.get("id", 0)) == run_id:
                  continue
              if str(run.get("name", "")) != workflow:
                  continue
              if str(run.get("head_branch", "")) != ref_name:
                  continue

              created_at = run.get("created_at")
              age_minutes: float | None = None
              if isinstance(created_at, str):
                  try:
                      created = datetime.strptime(
                          created_at,
                          "%Y-%m-%dT%H:%M:%SZ",
                      ).replace(tzinfo=timezone.utc)
                      age_minutes = (now - created).total_seconds() / 60.0
                  except ValueError:
                      age_minutes = None

              run_id_other = int(run.get("id", 0))
              run_url = str(run.get("html_url", ""))
              if str(run.get("head_sha", "")) == sha:
                  duplicates.append((run_id_other, run_url, age_minutes))
              if age_minutes is not None and age_minutes > max_stale_minutes:
                  stale.append((run_id_other, run_url, age_minutes))

          if duplicates:
              print("CI chain guard failed.")
              print("Duplicate in-progress runs for same workflow/ref/sha:")
              for rid, url, age in duplicates:
                  age_str = "unknown" if age is None else f"{age:.1f}m"
                  print(f" - run_id={rid} age={age_str} url={url}")
              raise SystemExit(1)

          if stale:
              print(
                  "CI chain guard warning: stale in-progress runs for same workflow/ref "
                  f"(>{max_stale_minutes:.0f}m):"
              )
              for rid, url, age in stale:
                  age_str = "unknown" if age is None else f"{age:.1f}m"
                  print(f" - run_id={rid} age={age_str} url={url}")

          print("CI chain guard passed: no duplicate in-progress runs found.")
          PY

  python-tests:
    name: Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: [ci-chain-guard]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Enforce local-only handovers exclusion
        if: matrix.python-version == '3.12'
        run: |
          tracked="$(git ls-files -- '.handovers/**' '.coordination/handovers/**')"
          if [ -n "$tracked" ]; then
            echo "::error::handover directories are local-only and must not be tracked."
            echo "$tracked"
            exit 1
          fi
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install "jax[cpu]" gymnasium

      - name: Bootstrap optional sc-neurocore modules (Python 3.12 lane)
        if: matrix.python-version == '3.12'
        run: |
          python - <<'PY'
          import importlib.util
          import shutil
          import subprocess
          import sys

          if importlib.util.find_spec("sc_neurocore") is not None:
              print("sc_neurocore already available.")
              raise SystemExit(0)

          if shutil.which("rustc") is None:
              print("rustc not available in this lane; continuing with numpy fallback path.")
              raise SystemExit(0)

          cmd = [
              sys.executable,
              "-m",
              "pip",
              "install",
              "git+https://github.com/anulum/sc-neurocore.git@df81aa28fd2db55665cacd87c3c4a62b7d8e077f#subdirectory=bridge",
          ]
          result = subprocess.run(cmd, check=False)
          if result.returncode != 0:
              print("Optional sc-neurocore bootstrap failed; continuing with fallback path.")
          PY
      - name: Python preflight release gate
        if: matrix.python-version == '3.12'
        run: python tools/run_python_preflight.py --gate release
      - name: Run release test suite (exclude experimental-only lanes)
        run: pytest tests/ -v -m "not experimental"
      - name: Generate Python coverage report
        if: matrix.python-version == '3.12'
        run: pytest tests/ -q -m "not experimental" --cov=scpn_fusion --cov-branch --cov-report=xml:coverage-python.xml
      - name: Coverage regression guard
        if: matrix.python-version == '3.12'
        run: |
          python tools/coverage_guard.py \
            --coverage-xml coverage-python.xml \
            --thresholds tools/coverage_guard_thresholds.json \
            --summary-json artifacts/coverage_guard_summary.json
      - name: Run property-based tests (Hypothesis)
        run: pytest tests/test_hypothesis_properties.py -v --hypothesis-seed=0
      - name: Disruption false-positive rate gate
        if: matrix.python-version == '3.12'
        run: |
          python -c "
          from scpn_fusion.control.disruption_predictor import run_anomaly_alarm_campaign
          r = run_anomaly_alarm_campaign(seed=42, episodes=32, window=64)
          assert r['false_positive_rate'] <= 0.10, f'FPR {r[\"false_positive_rate\"]:.3f} exceeds 10%%'
          "
      - name: Upload Python coverage to Codecov
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          files: coverage-python.xml
          flags: python
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      - name: Upload coverage guard summary
        if: matrix.python-version == '3.12'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-guard-summary
          path: artifacts/coverage_guard_summary.json

  python-research-gate:
    name: Python Research Gate
    runs-on: ubuntu-latest
    needs: [python-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install "jax[cpu]" gymnasium

      - name: Bootstrap optional sc-neurocore modules
        run: |
          python - <<'PY'
          import importlib.util
          import shutil
          import subprocess
          import sys

          if importlib.util.find_spec("sc_neurocore") is not None:
              print("sc_neurocore already available.")
              raise SystemExit(0)

          if shutil.which("rustc") is None:
              print("rustc not available in this lane; continuing with numpy fallback path.")
              raise SystemExit(0)

          cmd = [
              sys.executable,
              "-m",
              "pip",
              "install",
              "git+https://github.com/anulum/sc-neurocore.git@df81aa28fd2db55665cacd87c3c4a62b7d8e077f#subdirectory=bridge",
          ]
          result = subprocess.run(cmd, check=False)
          if result.returncode != 0:
              print("Optional sc-neurocore bootstrap failed; continuing with fallback path.")
          PY
      - name: Python preflight research gate
        run: python tools/run_python_preflight.py --gate research

  geometry-3d-smoke:
    name: Geometry 3D Smoke
    runs-on: ubuntu-latest
    needs: [python-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install "jax[cpu]" gymnasium

      - name: Run 3D quickstart smoke
        run: |
          python examples/run_3d_flux_quickstart.py --toroidal 12 --poloidal 12 --output artifacts/ci_3d_smoke.obj
          python examples/run_3d_flux_quickstart.py --vmec-like --n1-amplitude 0.04 --toroidal 12 --poloidal 12 --output artifacts/ci_3d_vmec_smoke.obj
      - name: Validate OBJ artifact
        run: |
          python - <<'PY'
          from pathlib import Path
          def validate_obj(path: Path) -> None:
              if not path.exists() or path.stat().st_size == 0:
                  raise SystemExit(f"OBJ artifact missing or empty: {path}")
              verts = 0
              faces = 0
              for line in path.read_text(encoding="utf-8").splitlines():
                  if line.startswith("v "):
                      verts += 1
                  elif line.startswith("f "):
                      faces += 1
              if verts <= 0 or faces <= 0:
                  raise SystemExit(f"Invalid mesh content for {path}: verts={verts}, faces={faces}")
              print(f"OBJ smoke OK {path.name}: verts={verts}, faces={faces}")

          validate_obj(Path("artifacts/ci_3d_smoke.obj"))
          validate_obj(Path("artifacts/ci_3d_vmec_smoke.obj"))
          PY

  rmse-dashboard-smoke:
    name: RMSE Dashboard Smoke
    runs-on: ubuntu-latest
    needs: [python-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install "jax[cpu]" gymnasium

      - name: Generate RMSE dashboard
        run: |
          python validation/rmse_dashboard.py --output-json artifacts/rmse_dashboard_ci.json --output-md artifacts/rmse_dashboard_ci.md
      - name: Validate dashboard artifacts
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          j = Path("artifacts/rmse_dashboard_ci.json")
          m = Path("artifacts/rmse_dashboard_ci.md")
          if not j.exists() or j.stat().st_size == 0:
              raise SystemExit("Missing RMSE JSON artifact")
          if not m.exists() or m.stat().st_size == 0:
              raise SystemExit("Missing RMSE Markdown artifact")
          data = json.loads(j.read_text(encoding="utf-8"))
          for key in ("confinement_itpa", "confinement_iter_sparc", "beta_iter_sparc", "sparc_axis"):
              if key not in data:
                  raise SystemExit(f"Missing key: {key}")
          print("RMSE dashboard smoke OK")
          PY
      - name: RMSE regression gate
        run: python tools/ci_rmse_gate.py
      - name: Upload RMSE artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rmse-dashboard-smoke
          path: |
            artifacts/rmse_dashboard_ci.json
            artifacts/rmse_dashboard_ci.md

  real-shot-validation:
    name: Real-Shot Validation Gate
    runs-on: ubuntu-latest
    needs: [python-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install "jax[cpu]" gymnasium

      - name: Run real-shot validation
        run: python validation/validate_real_shots.py
      - name: Upload validation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: real-shot-validation
          path: |
            artifacts/real_shot_validation.json
            artifacts/real_shot_validation.md

  rust-tests:
    name: Rust (stable)
    runs-on: ubuntu-latest
    needs: [ci-chain-guard]
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      - name: Check formatting
        run: cargo fmt --all -- --check
      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
      - name: Run tests (including proptest)
        run: cargo test --all-features -- --test-threads=1

  rust-python-interop:
    name: Rust-Python Interop
    runs-on: ubuntu-latest
    needs: [rust-tests]
    defaults:
      run:
        working-directory: .
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-interop-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-interop-
      - name: Create virtualenv and install Python package
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install maturin "jax[cpu]" gymnasium
      - name: Build Rust extension
        run: |
          source .venv/bin/activate
          cd scpn-fusion-rs/crates/fusion-python && maturin develop --release
      - name: Verify Rust extension loads
        run: |
          source .venv/bin/activate
          python -c "import scpn_fusion_rs; print('Rust extension loaded OK')"
      - name: Run interop tests
        run: |
          source .venv/bin/activate
          pytest tests/test_boris_pyo3_bridge.py tests/test_snn_pyo3_bridge.py \
                 tests/test_rust_python_parity.py tests/test_rust_compat_wrapper.py \
                 tests/test_rust_multigrid_wiring.py -v --tb=short
      - name: Run new binding tests
        run: |
          source .venv/bin/activate
          pytest tests/test_pyo3_physics_bridge.py tests/test_pyo3_control_bridge.py \
                 tests/test_pyo3_nuclear_bridge.py tests/test_pyo3_transport_bridge.py -v --tb=short

  rust-coverage:
    name: Rust Coverage (tarpaulin)
    runs-on: ubuntu-latest
    needs: [ci-chain-guard]
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-tarpaulin-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-tarpaulin-
      - name: Install cargo-binstall
        uses: taiki-e/install-action@cargo-binstall
      - name: Install cargo-tarpaulin
        run: |
          set -euo pipefail
          if cargo binstall --no-confirm --force cargo-tarpaulin; then
            exit 0
          fi
          echo "cargo-binstall path failed, retrying locked source build..."
          for attempt in 1 2 3; do
            if cargo install cargo-tarpaulin --locked; then
              exit 0
            fi
            echo "cargo install attempt ${attempt}/3 failed."
            sleep $((attempt * 10))
          done
          echo "cargo-tarpaulin install failed after retries."
          exit 1
      - name: Generate coverage
        run: cargo tarpaulin --packages fusion-types fusion-math fusion-core fusion-physics fusion-nuclear fusion-engineering fusion-control fusion-diagnostics fusion-ml --run-types Lib --timeout 300 --out xml --output-dir coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: scpn-fusion-rs/coverage/cobertura.xml
          flags: rust
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  rust-audit:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    needs: [ci-chain-guard]
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run security audit
        run: cargo audit

  rust-benchmarks:
    name: Rust Benchmarks
    runs-on: ubuntu-latest
    needs: [ci-chain-guard]
    defaults:
      run:
        working-directory: scpn-fusion-rs
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            scpn-fusion-rs/target
          key: ${{ runner.os }}-bench-${{ hashFiles('scpn-fusion-rs/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-bench-
      - name: Record hardware metadata
        run: |
          mkdir -p benchmark-results
          {
            echo "runner: github-actions ubuntu-latest"
            echo "cpu: $(lscpu | grep 'Model name' | sed 's/.*:\s*//')"
            echo "cores: $(nproc)"
            echo "ram_mb: $(free -m | awk '/Mem:/{print $2}')"
            echo "rustc: $(rustc --version)"
          } > benchmark-results/hardware.txt
      - name: Run benchmarks
        run: cargo bench 2>&1 | tee benchmark-results/bench_output.txt
      - name: Collect Criterion JSON
        if: always()
        run: |
          if [ -d target/criterion ]; then
            cp -r target/criterion benchmark-results/criterion_data
          fi
      - name: Upload benchmark artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rust-benchmarks
          path: scpn-fusion-rs/benchmark-results/

  validation-regression:
    name: Physics Validation Suite
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests, rust-python-interop]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install "jax[cpu]" gymnasium

      - name: Bootstrap optional sc-neurocore modules
        run: |
          python - <<'PY'
          import importlib.util
          import shutil
          import subprocess
          import sys

          if importlib.util.find_spec("sc_neurocore") is not None:
              print("sc_neurocore already available.")
              raise SystemExit(0)

          if shutil.which("rustc") is None:
              print("rustc not available in this lane; continuing with numpy fallback path.")
              raise SystemExit(0)

          cmd = [
              sys.executable,
              "-m",
              "pip",
              "install",
              "git+https://github.com/anulum/sc-neurocore.git@df81aa28fd2db55665cacd87c3c4a62b7d8e077f#subdirectory=bridge",
          ]
          result = subprocess.run(cmd, check=False)
          if result.returncode != 0:
              print("Optional sc-neurocore bootstrap failed; continuing with fallback path.")
          PY
      - name: IPB98 confinement scaling validation
        run: pytest tests/test_uncertainty.py -v --tb=short
      - name: Full regression suite
        run: pytest tests/ -v --tb=short -x -m "not experimental"

  stress-test:
    name: Stress Test
    runs-on: ubuntu-latest
    needs: [python-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install "jax[cpu]" gymnasium pytest-timeout
      - name: Run stress tests
        run: |
          pytest tests/ -v -m "stress" --timeout=600 || rc=$?
          if [ "${rc:-0}" -eq 5 ]; then
            echo "No stress-marked tests collected — skipping."
            exit 0
          fi
          exit "${rc:-0}"
